#!/usr/bin/expect

## RUN/CONT
proc trun { args } {
    spawn rdb Fact
    expect {
	-re "VM Started: .+\n.*MainThread... " {}
	timeout { error "can not reach initialization sequence" }
    }

    send "cont\n"
    expect {
	eof {puts "PASS\n" }
	timeout { error "can not complete" }
    }
}

## RUN/EXIT
proc texit { args } {
    spawn rdb Fact
    expect {
	-re "VM Started: .+\n.*MainThread... " {}
	timeout { error "can not reach initialization sequence" }
    }

    send "exit\n"
    expect {
	eof {puts "PASS\n" }
	timeout { error "can not complete" }
    }
}

## RUN/THREAD/STACK
proc tthreadAndStack { args } {
    spawn rdb Fact
    expect {
	-re "VM Started: .+\n.*MainThread... " {}
	timeout { error "can not reach initialization sequence" }
    }

    send "classes\n"
    expect {
	-re "MainThread... " {}
	timeout { error "can not enumerate the classes" }
    }
    
    send "threads\n"
    expect {
	-re "MainThread... " {}
	timeout { error "can not enumerate the threads" }
    }

    send "where\n"
    expect {
	-re "MainThread... " {}
	timeout { error "can not dump call frames" }
    }

    send "exit\n"
    expect {
	eof {puts "PASS\n" }
	timeout { error "can not complete"}
    }
}

##BREAKPOINT
proc tbreakpoint { args } {
    spawn rdb Fact
    expect {
	-re "VM Started: .+\n.*MainThread... " {}
	timeout { error "can not reach initialization sequence" }
    }

    send "stop at Fact:18\n"
    expect {
	-re "MainThread... " {}
	timeout { error "can not set break point" }
    }

    set i 0
    while { $i < 5 } {
	send "cont\n"
	expect {
	    -re "MainThread... " {}
	    timeout { error "can not stop at break point" }
	}
	send "where\n"
	expect {
	    -re "MainThread... " {}
	    timeout { error "can not dump call frames" }
	}
	incr i
    }

    send "cont\n"
    expect {
	eof {puts "PASS\n" }
	timeout { error "can not complete" }
    }
}



##EXPR
proc texpr { args } {
    spawn rdb Fact
    expect {
	-re "VM Started: .+\n.*MainThread... " {}
	timeout { error "can not reach initialization sequence" }
    }
    
    send "stop at Fact:18\n"
    expect {
	-re "MainThread... " {}
	timeout { error "can not set a break point" }
    }
    
    set i 0
    while { $i < 5 } {
	send "cont\n"
	expect {
	    -re "MainThread... " {}
	    timeout { error "can not continue" }
	}
	
	send "eval n\n"
	expect { 
	    -re "MainThread... " {}
	    timeout { error "can not evalute a local variable" }
	}

	send "eval Fact.fact(2)\n"
	expect { 
	    -re "MainThread... " {}
	    timeout { error "can not evalute a local variable" }
	}

	send "eval n + Fact.fact(2)\n"
	expect { 
	    -re "MainThread... " {}
	    timeout { error "can not evalute a local variable" }
	}

	send "eval Fact.fact(2) + Fact.fact(3)\n"
	expect { 
	    -re "MainThread... " {}
	    timeout { error "can not evalute a local variable" }
	}

	send "eval Fact.fact(Fact.fact(3))\n"
	expect { 
	    -re "MainThread... " {}
	    timeout { error "can not evalute a local variable" }
	}

	incr i
    }

    send "cont\n"
    expect {
	eof {puts "PASS\n" }
	timeout { error "can not complete" }
    }
}

proc tstep { args } {
    spawn rdb Fact
    expect {
	-re "VM Started: .+\n.*MainThread... " {}
	timeout { error "can not reach initialization sequence" }
    }
    send "stop in Fact.main\n"
    expect {
	-re "MainThread... " {}
	timeout { error "can not set breakpoint." }
    }
    send "cont\n"
    expect {
	-re "MainThread... " {}
	timeout { error "can not reach breakpoint." }
    }
    set i 0
    while { $i < 5 } {
	send "step\n"
	expect {
	    -re "MainThread... " {}
	timeout { error "can not reach breakpoint." }
	}
	incr i
    }
    send "cont\n"
    expect {
	eof {puts "PASS\n" }
	timeout { error "can not complete" }
    }
}

set timeout -1
trun
texit
tthreadAndStack
tbreakpoint
texpr
#tstep
